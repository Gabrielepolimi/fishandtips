name: ðŸ“Œ Pinterest Pin Generator

on:
  # Esecuzione programmata - genera pin ogni giorno
  schedule:
    # 08:00 UTC (09:00 ora italiana)
    - cron: '0 8 * * *'
  
  # Esecuzione manuale
  workflow_dispatch:
    inputs:
      article_slug:
        description: 'Slug articolo specifico (opzionale)'
        required: false
        type: string
      count:
        description: 'Numero di pin da generare dagli ultimi articoli'
        required: false
        default: '3'
        type: string

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
  CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
  CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
  CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
  SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
  NEXT_PUBLIC_SANITY_PROJECT_ID: '3nnnl6gi'
  NEXT_PUBLIC_SANITY_DATASET: 'production'

jobs:
  generate-pinterest-pins:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgbm-dev \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libasound2t64 \
            libpango-1.0-0 \
            libcairo2

      - name: ðŸ“Œ Generate Pinterest Pins
        run: |
          echo "ðŸ“Œ Pinterest Pin Generator"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "${{ github.event.inputs.article_slug }}" ]; then
            echo "ðŸ“ Articolo specifico: ${{ github.event.inputs.article_slug }}"
            node scripts/pinterest-rss-generator.js --article "${{ github.event.inputs.article_slug }}"
          else
            COUNT="${{ github.event.inputs.count || '3' }}"
            echo "ðŸ“Š Generazione $COUNT pin dagli ultimi articoli"
            node scripts/pinterest-rss-generator.js --latest $COUNT
          fi

      - name: ðŸ“¤ Commit and Push updated pins
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/pinterest-pins.json
          git diff --staged --quiet || git commit -m "ðŸ“Œ Auto-generate Pinterest pins [skip ci]"
          git push

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ“Œ Pinterest Pin Generator Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.article_slug }}" ]; then
            echo "- **Article**: ${{ github.event.inputs.article_slug }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Count**: ${{ github.event.inputs.count || '3' }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "I pin generati sono disponibili su:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ https://fishandtips.it/pinterest" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¡ https://fishandtips.it/pinterest/feed.xml" >> $GITHUB_STEP_SUMMARY
