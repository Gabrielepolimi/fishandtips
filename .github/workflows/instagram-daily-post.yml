# ğŸ“± FishandTips - Instagram Daily Auto-Post
# 
# Pubblica automaticamente un carousel Instagram ogni giorno
# Piano settimanale:
#   LunedÃ¬    07:00 - Tutorial (Esperto)
#   MartedÃ¬   12:30 - Meme (Divertente)
#   MercoledÃ¬ 19:00 - Errori (Provocatorio)
#   GiovedÃ¬   12:30 - Quiz (Amico)
#   VenerdÃ¬   07:00 - Confronto (Esperto)
#   Sabato    10:00 - Top 5 (Amico)
#   Domenica  18:00 - Storia (Storytelling)

name: ğŸ“± Instagram Daily Post

on:
  schedule:
    # Orari UTC (aggiungi +1 per Italia inverno, +2 per estate)
    - cron: '0 6 * * 1'   # LunedÃ¬ 07:00 IT (06:00 UTC)
    - cron: '30 11 * * 2' # MartedÃ¬ 12:30 IT
    - cron: '0 18 * * 3'  # MercoledÃ¬ 19:00 IT
    - cron: '30 11 * * 4' # GiovedÃ¬ 12:30 IT
    - cron: '0 6 * * 5'   # VenerdÃ¬ 07:00 IT
    - cron: '0 9 * * 6'   # Sabato 10:00 IT
    - cron: '0 17 * * 0'  # Domenica 18:00 IT
  
  # Permetti anche esecuzione manuale
  workflow_dispatch:
    inputs:
      content_type:
        description: 'Tipo di contenuto'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - tutorial
          - meme
          - mistakes
          - quiz
          - comparison
          - toplist
          - story
      topic:
        description: 'Argomento (lascia vuoto per auto)'
        required: false
        default: ''
      tone:
        description: 'Tono (lascia vuoto per auto)'
        required: false
        default: ''

jobs:
  post-instagram:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“š Install dependencies
        working-directory: ./fishandtips
        run: npm ci
      
      - name: ğŸ­ Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libasound2
      
      - name: ğŸ“… Determine content type
        id: content
        working-directory: ./fishandtips
        run: |
          # Se esecuzione manuale con tipo specificato
          if [ "${{ github.event.inputs.content_type }}" != "" ] && [ "${{ github.event.inputs.content_type }}" != "auto" ]; then
            echo "type=${{ github.event.inputs.content_type }}" >> $GITHUB_OUTPUT
            echo "tone=${{ github.event.inputs.tone }}" >> $GITHUB_OUTPUT
            echo "topic=${{ github.event.inputs.topic }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Usa lo script Node per selezionare topic variati
          OUTPUT=$(node scripts/daily-topic-selector.js 2>&1 | tail -3)
          
          TYPE=$(echo "$OUTPUT" | grep "^type=" | cut -d= -f2)
          TONE=$(echo "$OUTPUT" | grep "^tone=" | cut -d= -f2)
          TOPIC=$(echo "$OUTPUT" | grep "^topic=" | cut -d= -f2)
          
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "tone=$TONE" >> $GITHUB_OUTPUT
          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          
          echo "ğŸ“… Contenuto selezionato:"
          echo "   Tipo: $TYPE"
          echo "   Tono: $TONE"
          echo "   Topic: $TOPIC"
      
      - name: ğŸ¨ Generate and publish carousel
        working-directory: ./fishandtips
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTAGRAM_ACCOUNT_ID: ${{ secrets.INSTAGRAM_ACCOUNT_ID }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          echo "ğŸ“± Pubblicazione Instagram"
          echo "ğŸ“Š Tipo: ${{ steps.content.outputs.type }}"
          echo "ğŸ­ Tono: ${{ steps.content.outputs.tone }}"
          echo "ğŸ“ Topic: ${{ steps.content.outputs.topic }}"
          
          node scripts/batch-instagram-poster.js \
            --single \
            --type "${{ steps.content.outputs.type }}" \
            --topic "${{ steps.content.outputs.topic }}" \
            --tone "${{ steps.content.outputs.tone }}"
      
      - name: ğŸ“Š Log risultato
        if: always()
        run: |
          echo "âœ… Workflow completato"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ“± Tipo post: ${{ steps.content.outputs.type }}"

